# 应用授权管理系统改造说明 (V3)

## 版本更新说明

本版本（V3）在原有基础上进行了以下改进：

1. **组织机构授权管理优化**
   - 优化组织机构授权管理按钮文本，使功能更加直观明确
   - 改进弹窗内的提示文本，提高用户理解度
   - 简化操作流程，减少用户理解成本

2. **授权设置功能重构**
   - 将原有的"授权设置"功能拆分为更明确的操作：
     - "新增授权"：为未授权资源添加授权
     - "取消授权"：移除已有的授权
     - "编辑授权"：修改现有授权的有效期
   - 移除表单内的授权开关，简化操作逻辑
   - 批量授权设置同样采用新的操作模式
   - 操作列变成三个操作：新增授权/取消授权、编辑授权、查看其他授权
     - 非组合授权情形：
       - 未授权状态：显示蓝色的"新增授权"、灰色的"编辑授权"、灰色的"查看其他授权"
       - 已授权状态：显示蓝色的"取消授权"、蓝色的"编辑授权"、灰色的"查看其他授权"
     - 组合授权情形：
       - 直接授权为未授权状态：显示蓝色的"新增授权"、灰色的"编辑授权"、蓝色的"查看其他授权"
       - 直接授权为已授权状态：显示蓝色的"取消授权"、蓝色的"编辑授权"、蓝色的"查看其他授权"

## 原有功能（保留）

1. **用户授权例外设置**
   - 支持针对特定用户设置授权例外规则
   - 通过组织机构授权管理界面进行设置

2. **授权状态可视化**
   - 支持永久授权和临时授权两种模式的直观展示
   - 授权状态通过醒目的颜色标签直观展示

3. **操作列功能优化**
   - 操作列整合为三个主要功能：
     - "新增授权/取消授权"：根据当前授权状态动态显示
     - "编辑授权"：修改现有授权的有效期设置
     - "查看其他授权"：查看来自其他授权渠道的授权信息

4. **授权设置功能**
   - 基于白名单授权模式，默认禁止访问
   - 提供授权开关：开启表示允许访问，关闭表示禁止访问
   - 对于允许访问的情况，可进一步设置永久授权或临时授权
   - 当授权开关从关闭变为开启时，默认选择永久授权模式

## 授权状态判断逻辑

### 判断优先级（从高到低）

1. 如果 `授权类型 = none`
   → **未授权**（灰色标签）

2. 如果 `授权类型 = 永久`
   → **永久授权**（蓝色标签）

3. 如果 `授权类型 = 临时` 且 `开始日期 > 当前日期`
   → **未生效授权**（紫色标签 + 生效日期）

4. 如果 `授权类型 = 临时` 且 `当前日期 > 结束日期`
   → **授权已过期**（灰色标签）

5. 如果 `授权类型 = 临时` 且 `剩余天数 ≤ 7天`
   → **授权即将到期**（黄色标签 + 剩余天数）

6. 如果 `授权类型 = 临时` 且 `剩余天数 > 7天`
   → **临时授权**（绿色标签 + 日期范围）

### 组合授权状态判断

对于组合授权，状态判断逻辑如下：

1. 如果组合授权中包含永久授权
   → **永久授权**（蓝色标签 + 多个时间段）

2. 对于仅包含多个授权时间段的组合授权：

   a. 如果当前日期在所有授权时间段之前
      → **未生效授权**（紫色标签 + 生效日期）

   b. 如果当前日期在所有授权时间段之后
      → **授权已过期**（灰色标签）

   c. 如果当前日期在授权时间段的中间空窗期（即不在任何一个授权时间段内）
      → **授权已过期**（灰色标签）

   d. 如果当前日期在某个授权时间段内，且距离该时间段结束日期 ≤ 7天
      → **授权即将到期**（黄色标签 + 剩余天数）

   e. 如果当前日期在某个授权时间段内，且距离该时间段结束日期 > 7天
      → **临时授权**（绿色标签 + 日期范围）

### 状态说明

| 状态 | 判断条件 | 显示效果 |
|------|---------|----------|
| **永久授权** | 授权类型 = 永久<br>或 组合授权中包含永久授权 | 蓝色标签<br>蓝色标签 + 多个时间段 |
| **未生效授权** | 授权类型 = 临时 且 开始日期 > 当前日期<br>或 组合授权中当前日期在所有授权时间段之前 | 紫色标签 + 生效日期 |
| **授权已过期** | 授权类型 = 临时 且 当前日期 > 结束日期<br>或 组合授权中当前日期在所有授权时间段之后<br>或 组合授权中当前日期在授权时间段的中间空窗期 | 灰色标签 |
| **授权即将到期** | 授权类型 = 临时 且 在有效期内 且 剩余天数 ≤ 7天<br>或 组合授权中当前日期在某个授权时间段内 且 距离该时间段结束日期 ≤ 7天 | 黄色标签 + 剩余天数 |
| **临时授权** | 授权类型 = 临时 且 在有效期内 且 剩余天数 > 7天<br>或 组合授权中当前日期在某个授权时间段内 且 距离该时间段结束日期 > 7天 | 绿色标签 + 日期范围 |
| **未授权** | 授权类型 = none（授权开关关闭） | 灰色标签 |

## 操作列按钮显示逻辑

操作列包含三个功能按钮，根据资源的授权状态和授权类型动态显示。每个按钮的可点击状态和显示文本会根据资源的当前状态自动调整。

### 非组合授权情形

| 授权状态 | 新增授权/取消授权 | 编辑授权 | 查看其他授权 |
|---------|-----------------|---------|------------|
| **未授权** | 蓝色可点击（新增授权） | 灰色禁用 | 灰色禁用 |
| **已授权**（包括永久授权、临时授权、未生效授权、即将到期授权） | 蓝色可点击（取消授权） | 蓝色可点击 | 灰色禁用 |

### 组合授权情形

| 直接授权状态 | 新增授权/取消授权 | 编辑授权 | 查看其他授权 |
|------------|-----------------|---------|------------|
| **未授权** | 蓝色可点击（新增授权） | 灰色禁用 | 蓝色可点击 |
| **已授权**（包括永久授权、临时授权、未生效授权、即将到期授权） | 蓝色可点击（取消授权） | 蓝色可点击 | 蓝色可点击 |

### 操作交互说明

1. **新增授权/取消授权**
   - 点击"新增授权"按钮：打开授权设置弹窗，显示"新增授权"模式
   - 点击"取消授权"按钮：打开授权设置弹窗，显示"取消授权"确认选项

2. **编辑授权**
   - 仅在资源已有直接授权时可用
   - 点击后打开授权设置弹窗，显示"编辑授权"模式，预填充当前授权设置

3. **查看其他授权**
   - 在组合授权情形下可用
   - 点击后打开侧边抽屉，显示来自其他授权渠道的授权信息

## 功能逻辑说明

### 用户搜索功能

#### 搜索数据结构
- 用户数据包含：用户唯一标识、用户姓名、部门信息
- 部门信息采用层级结构，使用分隔符连接各层级

#### 搜索匹配逻辑
- 支持按用户姓名进行模糊匹配
- 支持按部门信息进行模糊匹配
- 空搜索时显示所有符合条件的用户

#### 过滤与排除规则
- 自动排除已在排除名单中的用户
- 自动排除已在临时选中列表中的用户
- 确保搜索结果不包含重复用户

#### 排序逻辑
- 搜索结果按数据源的原始顺序显示
- 不进行额外的排序处理
- 保持数据的原始排列顺序

#### 部门信息显示
- 部门层级信息格式化显示，支持层级省略
- 当部门层级过多时，显示前面几层，显示不完整的用省略符号表示
- 鼠标悬停时显示完整的部门路径信息

#### 交互方式
- 支持点击搜索按钮触发搜索
- 支持回车键触发搜索
- 支持空搜索显示所有可选用户

### 批量操作功能

#### 批量选择机制
- 通过复选框实现多选功能
- 支持全选/取消全选操作
- 实时显示已选择的资源数量

#### 批量操作按钮显示逻辑
- 仅在有资源被选中时显示批量操作按钮
- 按钮文本动态显示选中的资源数量
- 切换页面或清空选择时自动隐藏按钮

#### 批量授权流程
- 打开批量授权弹窗，显示统一的授权设置界面
- 弹窗标题明确标识为批量操作并显示资源数量
- 授权设置将应用到所有选中的资源
- 支持批量设置永久授权或临时授权

#### 批量取消授权流程
- 显示确认对话框，明确提示将要取消授权的资源数量
- 用户确认后批量执行取消授权操作
- 操作完成后自动清除选择状态

### 弹窗交互逻辑

#### 弹窗打开与关闭
- 支持点击关闭按钮关闭弹窗
- 支持点击取消按钮关闭弹窗
- 支持点击弹窗外部区域关闭弹窗
- 关闭时自动清理弹窗状态和临时数据

#### 弹窗状态管理
- 弹窗打开时记录当前编辑的资源信息
- 批量操作时动态修改弹窗标题和按钮行为
- 关闭弹窗时重置所有临时状态

#### 表单数据处理
- 表单数据实时验证和状态更新
- 支持表单重置和数据回填
- 错误状态的清理和恢复

### 状态管理机制

#### 页面状态同步
- 左侧实体选择与右侧资源列表联动
- 搜索状态与列表显示状态同步
- 批量选择状态与操作按钮状态同步

#### 数据状态更新
- 授权状态变更后立即更新界面显示
- 批量操作完成后批量更新相关状态
- 状态变更时触发相关联动效果

#### 临时状态管理
- 弹窗中的临时选择状态独立管理
- 操作确认前临时状态不影响主界面
- 取消操作时清理所有临时状态

### 数据处理规则

#### 授权状态判断优先级
- 未授权状态优先级最高
- 永久授权状态次之
- 临时授权根据时间范围进一步细分状态
- 组合授权状态需要综合多个时间段判断

#### 组合授权处理逻辑
- 支持多个时间段的组合授权
- 支持永久授权与临时授权的混合
- 根据当前时间判断组合授权的有效状态
- 空窗期状态的特殊处理

#### 数据过滤与排序
- 根据应用类型过滤显示不同的资源集合
- 搜索过滤支持多字段模糊匹配
- 保持数据的原始顺序，不进行额外排序

## 继承设置功能说明

### 组织机构授权继承机制
- 用户默认继承所在组织机构的授权设置
- 可通过"组织机构授权排除"功能设置例外用户
- 排除名单中的用户不会自动获得组织机构授权
- 被排除用户仍可通过用户组进行批量授权或单独授权

### 排除名单管理功能
- 支持启用/关闭用户排除名单功能
- 排除名单为空时显示提示信息
- 支持添加用户到排除名单
- 支持从排除名单中移除用户
- 排除名单状态实时更新界面显示

### 继承设置弹窗交互
- 弹窗开关状态根据当前继承状态初始化
- 开关控制用户列表区域的显示/隐藏
- 支持取消操作，恢复原始状态
- 保存时更新继承状态并刷新资源表格
- 关闭继承时自动清空排除用户列表

### 用户添加弹窗功能
- 支持搜索用户进行添加
- 临时选择状态独立管理
- 支持批量选择和批量添加
- 确认添加时将临时选择转为正式排除名单
- 取消操作时清理临时选择状态

## 授权时间段处理逻辑

### 单时间段授权判断
- 未生效：当前日期小于开始日期
- 已过期：当前日期大于结束日期
- 即将到期：在有效期内且剩余天数≤7天
- 正常有效：在有效期内且剩余天数>7天

### 组合授权时间段判断
- 时间段按开始日期排序处理
- 检查当前日期是否在任意时间段内
- 判断是否在所有时间段之前/之后
- 空窗期（不在任何时间段内）视为已过期
- 包含永久授权时整体状态为永久授权

### 授权状态优先级处理
1. 未授权（授权类型=none）
2. 永久授权（授权类型=永久或组合中包含永久）
3. 未生效授权（开始日期>当前日期）
4. 已过期授权（结束日期<当前日期或在空窗期）
5. 即将到期授权（剩余天数≤7天）
6. 临时授权（剩余天数>7天）

### 时间计算规则
- 使用当前日期与授权时间段进行比较
- 剩余天数计算精确到天
- 7天预警机制用于即将到期提醒
- 组合授权需要逐个时间段进行状态判断