# 应用授权改造

## 改造概述

新增了授权排除功能，支持针对组织机构排除部分用户。改造了授权状态的显示方式，由原有的勾选框展示变更为授权状态列展示。调整了查看其他授权列，在弹窗中整合了新增授权/编辑授权/取消授权的功能。授权表单新增批量授权和批量取消授权的操作。

## 核心功能说明

### 1. 授权排除功能

#### 功能概述
授权排除功能是虎盾的新增功能，允许管理员设置特定用户的授权排除规则。被排除的用户即使通过组织机构获得了某项资源的授权，也会被系统自动排除，无法访问该资源。

#### 排除机制
- **排除优先级**：授权排除具有最高优先级，会移除组织机构获得的授权
- **排除范围**：可以针对特定资源设置用户排除名单
- **排除机制**：排除规则在各个管理员之间不互通，每个管理员只能设置自己的排除规则

#### 排除用户界面
- **多选下拉框**：支持搜索和多选用户进行排除设置
- **搜索功能**：支持按用户姓名进行模糊搜索
- **标签显示**：已选择的排除用户以标签形式显示，支持单独删除
- **实时更新**：排除名单变更后立即生效

#### 交互逻辑
- **状态反馈**：操作完成后显示相应的成功或错误提示

### 2. 授权状态展示

#### 状态列设计
与原产品使用勾选框表示授权状态不同，改造后采用专门的"授权状态"列来展示详细的授权信息，提供更丰富的状态可视化。

#### 所有授权状态一览

| 状态名称 | 显示文本 | 颜色 | 说明 |
|---------|---------|------|------|
| 未授权 | 未授权 | 灰色 | 资源未获得任何授权 |
| 永久授权 | 永久授权 | 蓝色 | 资源获得任意永久性授权，无时间限制 |
| 未生效授权 | 未生效授权 | 紫色 | 所有授权尚未开始生效 |
| 临时授权 | 临时授权 | 绿色 | 授权当前有效且距离到期超过7天 |
| 授权即将到期 | 授权即将到期 | 橙色 | 授权当前有效但距离到期不足7天 |
| 授权已过期 | 授权已过期 | 灰色 | 所有授权已经过期失效 |
| 授权空窗期 | 授权空窗期 | 灰色 | 在多个授权时间段之间的空隙期 |

#### 单独授权判断逻辑

**判断流程**：
1. 如果授权类型为未授权 → **未授权**
2. 如果授权类型为永久授权 → **永久授权**
3. 对于临时授权：
   - 如果当前日期 < 开始日期 → **未生效授权**
   - 如果当前日期 > 结束日期 → **授权已过期**
   - 如果当前日期在有效期内：
     - 距离结束日期 ≤ 7天 → **授权即将到期**
     - 距离结束日期 > 7天 → **临时授权**

#### 组合授权判断逻辑

**适用范围**：多个时间段的组合授权

**重叠时间段处理规则**：
- 当多个时间段存在重叠时，不进行物理合并，而是按重叠情况判断状态
- 例如：时间段A（1月1日-1月15日）和时间段B（1月10日-1月31日）存在重叠
- 判断"即将到期"时，如果当前时间在多个重叠时间段内，取最晚的失效时间来判断是否即将到期

**判断流程**：
1. 如果包含永久授权时间段 → **永久授权**
2. 对于临时授权时间段：
   - 如果当前日期早于所有时间段 → **未生效授权**
   - 如果当前日期晚于所有时间段 → **授权已过期**
   - 如果当前日期在某个或多个时间段内：
     - 找出包含当前日期的所有时间段，取其中最晚的结束日期
     - 距离最晚结束日期 ≤ 7天 → **授权即将到期**
     - 距离最晚结束日期 > 7天 → **临时授权**
   - 如果当前日期不在任何时间段内（处于空隙期）→ **授权空窗期**

#### 显示规则

**状态文本**：表格中只显示状态名称（如"临时授权"）

**时间信息**：鼠标悬停时显示详细时间，格式为 `(开始日期 至 结束日期)`或`(永久授权)`

**组合授权时间显示**：多个时间段用逗号分隔显示

### 3. 授权详情列

#### 功能扩展
原有产品功能“查看其他授权”已被整合到授权详情列中，并新增了查看直接授权的功能。
- **直接授权显示**：在授权详情抽屉中首行显示当前资源的直接授权状态
- **新增授权（浅蓝色）**：支持为未直接授权的主体和应用新增直接授权
- **编辑有效期（蓝色）**：支持编辑现有的直接授权和间接授权
- **取消授权（红色）**：支持取消任意类型的授权
- **保存修改（绿色）**：在授权详情抽屉中新增或编辑授权时显示，点击后保存对授权的变更
- **取消修改（灰色）**：在授权详情抽屉中新增或编辑授权时显示，点击后取消对授权的变更

#### 授权详情图标设计
- **统一编辑图标**：使用单一的编辑图标代替原来的多个操作按钮
- **动态菜单**：点击编辑图标后根据当前授权状态动态弹出当前主体和资源的授权详情抽屉

#### 授权详情菜单逻辑

**未授权状态（直接授权）**：
- 显示"新增授权"选项
- 点击后首行新增一条编辑状态的直接授权，用户可以修改授权有效期后保存，也可以点击取消修改取消修改

**已授权状态（直接授权）**：
- 显示"编辑有效期"选项
- 显示"取消授权"选项
- 编辑时可修改授权时间范围

**间接授权**：
- 显示"编辑有效期"选项
- 显示"取消授权"选项

**组合授权优先级**：
- 优先显示直接授权（首行显示）
- 仅当无直接授权时存在新增授权按钮，点击后新增一条直接授权

#### 权限控制
- **操作权限**：根据当前用户的管理员角色显示不同的授权，总管理员可查看所有授权，子管理员仅能查看和管理自己负责的授权
- **授权排除**：如果设置了授权排除名单，查看授权详情时，需要排除相应的组织机构授权。

### 4. 批量编辑功能

#### 批量选择机制
- **复选框选择**：每行资源前显示复选框，支持单选和多选
- **全选功能**：表头提供全选/取消全选复选框
- **跨页选择**：支持跨页面保持选择状态
- **选择计数**：实时显示已选择的资源数量
- **选择限制**：可设置最大选择数量限制

#### 批量操作按钮
- **动态显示**：仅在有资源被选中时显示批量操作按钮
- **操作类型**：提供"批量授权"和"批量取消授权"两个主要操作
- **数量显示**：按钮文本动态显示选中资源数量，如"批量授权(5)"

#### 批量授权流程
1. **选择资源**：通过复选框选择需要授权的资源
2. **点击批量授权**：点击"批量授权"按钮
3. **统一设置**：打开批量授权弹窗，设置统一的授权参数
4. **确认执行**：确认后对所有选中资源应用相同的授权有效期设置
5. **结果反馈**：自动更新资源状态并清除选择，显示批量操作成功提示（批量授权成功）

#### 批量取消授权流程
1. **选择资源**：选择需要取消授权的资源
2. **点击批量取消授权**：点击"批量取消授权"按钮
3. **确认对话框**：显示确认对话框，提示"批量操作：确定要取消这 [数量] 个选中资源的授权吗？"，[数量]为选中资源的数量
4. **执行操作**：确认后批量执行取消授权操作
5. **结果反馈**：自动更新资源状态并清除选择，显示批量操作成功提示（批量取消授权成功）


### 5. 提示信息说明

#### 内联错误提示（时间组件下方显示）

**批量授权弹窗中的日期验证**：
- 请选择开始日期 - 触发时机：批量授权弹窗中开始日期为空时
- 请选择结束日期 - 触发时机：批量授权弹窗中结束日期为空时
- 开始日期不能晚于结束日期 - 触发时机：批量授权弹窗中日期逻辑错误时


#### Toast消息（右上角弹出提示）

**成功消息（Success）**：
- 批量授权成功 - 触发时机：批量授权弹窗操作完成后
- 批量取消授权成功 - 触发时机：批量取消授权操作完成后
- 应用授权已更新 - 触发时机：新增授权、修改授权有效期操作完成后
- 已取消授权 - 触发时机：单个授权取消操作完成后
- 授权排除设置已更新 - 触发时机：授权排除弹窗设置保存成功后

**信息消息（Info）**：
- 已切换到总管理员视图 - 触发时机：从用户组视图切换到总管理员视图时
- 已切换到[管理员角色名]视图 - 触发时机：从总管理员视图切换到特定用户组视图时
- 已添加新授权，请编辑后保存 - 触发时机：点击"新增授权"按钮创建新行后

**错误消息（Error）**：
- 请同时设置开始日期和结束日期 - 触发时机：授权详情抽屉保存时日期不完整
- 开始日期不能晚于结束日期 - 触发时机：授权详情抽屉保存时日期逻辑错误
- 未找到授权数据 - 触发时机：尝试操作不存在的授权记录时

#### 确认对话框（浏览器弹窗）

**取消授权确认**：
- 授权关系取消："确定要取消这条授权关系吗？此操作不可撤销。" - 触发时机：在授权详情抽屉中删除特定关系时

**数据丢失警告**：
- "您做的修改尚未保存，确认退出吗？" - 触发时机：编辑状态下尝试关闭抽屉或切换页面时

#### Toast功能特性

**显示机制**：
- 自动显示在页面右上角
- 3秒后自动消失
- 鼠标悬停时暂停自动消失
- 支持手动点击关闭

**样式特性**：
- 成功消息：绿色对勾图标
- 信息消息：蓝色信息图标
- 错误消息：红色叹号图标
- 支持多条消息堆叠显示

**交互行为**：
- 点击关闭按钮可立即关闭
- 鼠标离开后恢复自动消失倒计时
- 新消息会推送旧消息向上移动
- 动画效果：淡入淡出过渡

### 6. 申请权限与权限审批

#### 功能概述
申请权限与权限审批功能是产品已有的审批流程模块，支持用户申请权限和管理员审批权限的完整流程。受授权有效期功能影响，该功能模块也有所调整。

#### 申请权限功能

**应用列表展示规则**：
- **扩展显示范围**：除原本的未授权应用外，还显示已授权但当前不在有效期内或即将到期的应用
- **自助申请限制**：未勾选"允许用户自助申请访问权限"的应用不会出现在列表中
- **便民设计**：方便用户对即将到期或已过期的应用重新申请权限

**状态列优化**：
- **审批状态列**：原"状态列"调整为"审批状态"，包含3种状态：
  - "-"（无申请状态）
  - "待审批"（橙色显示）
  - "已驳回"（红色显示）
- **操作按钮调整**："待审批"状态下的操作由灰色"申请权限"调整为蓝色"编辑申请"

**新增授权状态列**：
在"应用"与"审批状态"之间新增"授权状态"列，包含5种状态：
- "未授权"（灰色显示）
- "未生效授权"（紫色显示）
- "授权即将到期"（橙色显示）
- "授权空窗期"（灰色显示）
- "授权已过期"（灰色显示）

**申请权限弹窗调整**：
- **授权有效期必填**：新增授权有效期必填项
- **默认设置**：授权有效期默认选择"永久有效"
- **时间选择**：选择"设置有效期"时显示时间选择组件
- **时间验证**：授权开始时间和结束时间必须同时存在，且开始时间必须早于结束时间

**多端同步**：
- **客户端支持**：客户端申请权限功能完整实现
- **Portal同步**：Portal页面申请权限功能同步修改
- **一致性保证**：确保两端功能和交互体验的一致性

**申请校验逻辑**：
提交申请时按优先级进行以下校验（不同时触发）：
1. **应用可用性校验**：如果管理员取消勾选"允许用户自助申请访问权限"或应用已被移除，报错"未找到应用数据"
2. **申请状态校验**：如果编辑申请时原始申请已被通过，报错"原申请已通过，无法编辑"
3. **授权状态校验**：如果授权状态已是"临时授权"或"永久授权"，报错"未找到应用数据"


#### 审批页面优化
**搜索功能增强**：
- **授权时间筛选**：在用户信息搜索框后新增"授权生效时间"和"授权失效时间"筛选条件
- **永久授权处理**：授权有效期为永久的记录在时间筛选时始终显示
- **筛选逻辑**：支持按授权有效期范围进行精确筛选

**字段扩展**：
- **授权有效期字段**：在用户信息字段后新增授权有效期显示
- **表格布局优化**：由于字段增加导致表格宽度不足，新增横向滚动条
- **固定操作列**：末尾操作列保持固定位置，其余列支持左右滚动

**子页面同步**：
以上所有修改同步应用到权限审批的所有子页面：
- 待审批页面
- 已通过页面
- 已驳回页面

**通过审批操作**：
- **授权有效期编辑**：管理员在通过审批时可以对授权有效期进行编辑
- **审批人备注**：支持管理员填写审批人备注信息（非必填）

**驳回审批操作**：
- **审批人备注**：驳回时支持管理员填写审批人备注（非必填）

#### 审批记录管理

**审批人备注显示**：
- **备注字段**：在审批记录列表中新增审批人备注字段
- **空值处理**：审批人备注为空时，统一使用横杠"-"表示
- **一致性原则**：与产品中其他模块的空值显示保持一致

#### 自动授权机制

**授权同步**：
- **自动创建**：审批通过后，系统根据审批信息自动在【应用授权】模块新增相应授权
- **实时生效**：授权变更立即在系统中生效